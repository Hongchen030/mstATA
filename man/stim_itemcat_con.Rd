% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/stim_itemcat_con.R
\name{stim_itemcat_con}
\alias{stim_itemcat_con}
\title{Generate Itemset-Level Constraints for Minimum/Exact/Maximum Numbers of
Stimulus-Linked Items from Specific Categorical Levels}
\usage{
stim_itemcat_con(
  x,
  attribute,
  cat_levels,
  min = NULL,
  max = NULL,
  which_module = NULL,
  which_pathway = NULL
)
}
\arguments{
\item{x}{An object of class \code{"mstATA_design"} created by \code{mst_design()}.}

\item{attribute}{A string giving the column name in \code{x$ItemPool} that
represents the \strong{item-level categorical attribute}.}

\item{cat_levels}{Character vector of category levels to constrain. Must match values
in \code{attribute}.}

\item{min}{Optional lower bound (scalar, vector, or matrix) specifying the
minimum number of items from each specified category level that must be
selected when the stimulus is selected.}

\item{max}{Optional upper bound (scalar, vector, or matrix) specifying the
maximum number of items from each specified category level that may be
selected when the stimulus is selected.}

\item{which_module}{Integer vector of modules. Must be consistent with the choices made in
\code{test_stimcount_con()}, \code{test_stimcat_con()},
and \code{test_stimquant_con()}.}

\item{which_pathway}{Integer vector of pathways. Must be consistent with the choices made in
\code{test_stimcount_con()}, \code{test_stimcat_con()},
and \code{test_stimquant_con()}.}
}
\value{
An object of S3 class \code{"mstATA_constraint"} with named elements:
\describe{
\item{name}{A character vector indicating the specifications in each row of \code{A_binary}}
\item{specification}{A \code{data.frame} summarizing the constraint specification, including
the requirement name, attribute, constraint type, application level,
operator, and the number of constraint rows generated.}
\item{A_binary}{A sparse binary matrix representing the linear constraint coefficients.}
\item{A_real}{NULL for 'mstATA_constraint' object}
\item{operators}{A character vector of constraint operators, one per row of \code{A_binary}.}
\item{d}{A numeric vector of right-hand-side values for the constraints.}
\item{C_binary}{NULL for 'mstATA_constraint' object}
\item{C_real}{NULL for 'mstATA_constraint' object}
\item{sense}{NULL for 'mstATA_constraint' object}
}
}
\description{
This function constructs linear constraints ensuring that, for every selected
stimulus, the items associated with that stimulus meet the required minimum,
exact, or maximum counts from specified categorical levels (e.g., content
area, skill type, item format).

The total number of generated constraints depends on the number of involved modules,
the provided values of \code{min} and \code{max} and on the number of category levels included in
\code{cat_levels}.

\itemize{

\item \strong{Full selection (\code{min = NULL} and \code{max = NULL}):}
If a stimulus is selected, items linked to that stimulus and belonging
to the specified category level must all be selected.

The number of constraints:
\strong{(number of category levels) × (number of stimuli) × (number of invovled modules)}.

\item \strong{Only \code{max} is specified:}
Only upper bounds are imposed per category level.

The number of constraints:
\strong{(number of category levels) × (number of stimuli) × (number of invovled modules)}.

\item \strong{Only \code{min} is specified:}
Lower bounds are imposed; upper bounds default to the total number of
items within each category level belonging to each stimulus.

The number of constraints:
\strong{2 × (number of category levels) × (number of stimuli) × (number of invovled modules)}.

\item \strong{Both \code{min} and \code{max} specified}
Lower and upper bounds are both active.

If min ≠ max (lower and upper bound are both active), the number of constraints:
\strong{2 × (number of category levels) × (number of stimuli) × (number of invovled modules)}.

If min = max (exact number), the number of constraints:
\strong{(number of category levels) × (number of stimuli) × (number of invovled modules)}.

}
}
\details{
\strong{1. Specification}

The constraint enforced is:

\strong{If a stimulus is selected, a minimum, exact, or maximum number of its
linked items must belong to the specified category level.}

The key properties of this constraint are:

\itemize{

\item The attribute type is \emph{logical}: a conditional
"if–then" relationship between the selection of a stimulus and the required
selection of its associated items.

\item The attribute is defined at the \emph{itemset level: set size for each stimulus} in the item pool
through the mapping between a stimulus and the items that belong to it.

\item \emph{Conditional} stimulus–item constraints (such as
\code{stim_itemcount_con()}, \code{stim_itemcat_con()},
\code{stim_itemquant_con()}) must be applied at the \code{"Module-level"} because
\strong{items linked to a selected stimulus cannot be distributed across multiple modules}: if the stimulus is
selected in a module, all items required from that stimulus must appear in
the same module.

\item \strong{Important:} The arguments \code{which_module} and
\code{which_pathway} must be consistent with the choices made in
\code{test_stimcount_con()}, \code{test_stimcat_con()},
and \code{test_stimquant_con()}.
}

\strong{2. Why gating is not required}

When only \code{min} is provided, the upper bound \eqn{n_c^{\max}} is
automatically set to the total number of items in category c within
stimulus s.

This produces a safe gating constraint: if the pivot item is not selected
(meaning the stimulus is not selected), then \eqn{x_{i_s^{*},m} = 0}
forces all corresponding item-selection variables \eqn{x_{i_s,m} = 0},
ensuring that no items from an unselected stimulus can be selected.
}
\section{Mathematical Formulation}{


Suppose the item pool contains (S - 1) stimulus-based item sets, indexed by
\eqn{s = 1, \ldots, S - 1}. Each stimulus has a designated pivot item,
indexed by \eqn{i_s^{*}}. In addition, the pool contains a set of discrete
(non–stimulus-based) items, which are represented by a dummy stimulus
\eqn{s = S} to allow a unified indexing scheme. Items belonging to stimulus
\eqn{s} are indexed as \eqn{i_s = 1, 2, \ldots, I_s}.

Suppose there are \eqn{M} modules in an MST panel. Let
\eqn{m = 1, \ldots, M} denote the module index.

Let \eqn{V_c^{item}} denote the set of
items that belong to category c.

\deqn{
  n_c^{\min} \, x_{i_s^{*},m}
  \;\le\;
  \sum_{i_s \in V_c^{\mathrm{item}}} x_{i_s,m}
  \;\le\;
  n_c^{\max} \, x_{i_s^{*},m},
  \qquad s = 1, \ldots, S - 1.
}

Here:
\itemize{
\item \eqn{x_{i_s,m}} is the binary decision variable indicating whether
item \eqn{i_s} is selected into module m.

\item \eqn{x_{i_s^{*},m}} indicates whether the pivot item for stimulus
s is selected into module m, thereby indicating whether the
stimulus s is selected in that module.

\item \eqn{n_c^{\min}} and \eqn{n_c^{\max}} are the required minimum and maximum
number of stimulus-based items from category level c if stimulus s is selected.
}
}

\examples{
data("reading_itempool")

pivot_stim_map <- create_pivot_stimulus_map(
  itempool   = reading_itempool,
  stimulus   = "stimulus",
  pivot_item = "pivot_item"
)

test_mstATA <- mst_design(
  itempool      = reading_itempool,
  design        = "1-3-3",
  module_length = c(14,12,12,12,12,12,12),
  pivot_stim_map = pivot_stim_map
)

# Example 1: Full selection (min = NULL, max = NULL)
# If a stimulus is selected, all MC and all TEI items in that stimulus must be selected.
# Constraint count:
#   7 modules × 10 stimuli × 2 category levels = 140 constraints
stim_itemcat_con(
  x = test_mstATA,
  attribute = "itemtype",
  cat_levels = c("MC","TEI")
)

# Example 2: Range selection (min and max specified)
# Between 1–5 MC items and 0–2 TEI items must be selected when the stimulus is selected.
# Both lower and upper bounds active → ×2
# Constraint count:
#   2 × (7 modules × 10 stimuli × 2 category levels) = 280 constraints
stim_itemcat_con(
  x = test_mstATA,
  attribute = "itemtype",
  cat_levels = c("MC","TEI"),
  min = c(1,0),
  max = c(5,2)
)

# Example 3: Minimum-only
# At least 2 MC and at least 1 TEI item must be selected when the stimulus is selected.
# Upper bound defaults → both bounds active → ×2
# Constraint count:
#   2 × (7 modules × 10 stimuli × 2 category levels) = 280 constraints
stim_itemcat_con(
  x = test_mstATA,
  attribute = "itemtype",
  cat_levels = c("MC","TEI"),
  min = c(2,1)
)

# Example 4: Maximum-only
# At most 5 MC and at most 3 TEI items may be selected from each stimulus.
# Only upper bound active
# Constraint count:
#   7 modules × 10 stimuli × 2 category levels = 140 constraints
stim_itemcat_con(
  x = test_mstATA,
  attribute = "itemtype",
  cat_levels = c("MC","TEI"),
  max = c(5,3)
)

# Example 5: Exact selection (min = max)
# Exactly 4 MC and 2 TEI items must be selected from each stimulus.
# Equality behaves like a single bound → no doubling
# Constraint count:
#   7 modules × 10 stimuli × 2 category levels = 140 constraints
stim_itemcat_con(
  x = test_mstATA,
  attribute = "itemtype",
  cat_levels = c("MC","TEI"),
  min = c(4,2),
  max = c(4,2)
)
}
\seealso{
\code{\link[=stim_itemcount_con]{stim_itemcount_con()}},\code{\link[=stim_itemquant_con]{stim_itemquant_con()}}
}
