% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/test_stimcat_con.R
\name{test_stimcat_con}
\alias{test_stimcat_con}
\title{Generate Module/Pathway-Level Constraints for the Min/Exact/Max Number of Stimuli
from Specific Categorical Levels}
\usage{
test_stimcat_con(
  x,
  attribute,
  cat_levels,
  operator,
  target_num,
  which_module = NULL,
  which_pathway = NULL
)
}
\arguments{
\item{x}{An object of class \code{"mstATA_design"} created by \code{mst_design()}.}

\item{attribute}{A string giving the column name in \code{x$ItemPool} that
represents the \strong{stimulus-level categorical attribute}.}

\item{cat_levels}{Character string or vector of category levels to constrain.}

\item{operator}{A character string indicating the type of constraint.
Must be one of \code{"<="}, \code{"="}, or \code{">="}.}

\item{target_num}{Target number of stimuli per category per module/pathway.
Can be a scalar, vector, or matrix (see Details).}

\item{which_module}{Optional integer vector of module indices to which the constraints
apply.}

\item{which_pathway}{Optional integer vector of pathway indices to which the
constraints apply.}
}
\value{
An object of S3 class \code{"mstATA_constraint"} with named elements:
\describe{
\item{name}{A character vector indicating the specifications in each row of \code{A_binary}}
\item{specification}{A \code{data.frame} summarizing the constraint specification, including
the requirement name, attribute, constraint type, application level,
operator, and the number of constraint rows generated.}
\item{A_binary}{A sparse binary matrix representing the linear constraint coefficients.}
\item{A_real}{NULL for 'mstATA_constraint' object}
\item{operators}{A character vector of constraint operators, one per row of \code{A_binary}.}
\item{d}{A numeric vector of right-hand-side values for the constraints.}
\item{C_binary}{NULL for 'mstATA_constraint' object}
\item{C_real}{NULL for 'mstATA_constraint' object}
\item{sense}{NULL for 'mstATA_constraint' object}
}
}
\description{
This function generates linear constraints on the number of \emph{stimuli} belonging
to specified categorical levels (e.g., passage type, theme, genre) in a multistage
test (MST).

Constraints may be applied at:
\itemize{
\item \strong{"Module-level"} — each module is treated as an independent form.
\item \strong{"Pathway-level"} — each pathway is treated as an independent form.
}

The application level is determined by which of
\code{which_module} or \code{which_pathway} is supplied.

The total number of constraints depends on the application level and on the
number of categorical levels included in \code{cat_levels}:

\itemize{
\item \strong{Module-level:} when \code{which_module} is provided
OR both \code{which_module} and \code{which_pathway} are \code{NULL}

The number of constraints is
\strong{(number of category levels) × (number of modules specified)}

\item \strong{Pathway-level:} when \code{which_pathway} is provided and
\code{which_module = NULL}

The number of constraints is
\strong{(number of category levels) × (number of pathways specified)}
}

Users may constrain only a subset of modules or pathways using
\code{which_module} or \code{which_pathway}, and may restrict the constraints
to a subset of stimulus categories using \code{cat_levels}.
}
\details{
\strong{1. Specification}

The constraint enforces:

\strong{The test must meet a minimum, exact, or maximum number of stimuli
belonging to each specified categorical level.}

Key characteristics:
\itemize{
\item The attribute type is \emph{categorical}.
\item The attribute is defined at the \emph{stimulus level} in the item pool.
\item The constraints are applied at either \strong{"Module-level"} or \strong{"Pathway-level"}.
}

\strong{2. Pivot-Item Method}

MST assembly uses the \strong{pivot-item formulation} (van der Linden, 2005):

\itemize{
\item Each stimulus has one designated pivot item \eqn{i_s^{*}}.
\item A stimulus is considered selected if and only if its pivot item
is selected.
}
}
\section{Mathematical Formulation}{


Suppose the item pool contains (S - 1) stimulus-based item sets, indexed by
\eqn{s = 1, \ldots, S - 1}. Each stimulus has a designated pivot item,
indexed by \eqn{i_s^{*}}. In addition, the pool contains a set of discrete
(non–stimulus-based) items, which are represented by a dummy stimulus
\eqn{s = S} to allow a unified indexing scheme. Items belonging to stimulus
\eqn{s} are indexed as \eqn{i_s = 1, 2, \ldots, I_s}.

Suppose there are \eqn{M} modules in an MST panel. Let
\eqn{m = 1, \ldots, M} denote the module index.

Let \eqn{V_c^{stim}} denote the set of
stimuli that belong to category c.

\strong{1. Module-level constraint (for module m)}

\deqn{\sum_{s \in V_c^{stim}} x_{i_s^{*},m} \;\substack{\le \\ \ge \\ =}\; n_c^{stim,m}}

\strong{2. Pathway-level constraint (for pathway r)}

\deqn{\sum_{m \in r} \sum_{s \in V_c^{stim}} x_{i_s^{*},m} \;\substack{\le \\ \ge \\ =}\; n_c^{stim,r}}

Here:
\itemize{
\item \eqn{x_{i_s^{*},m}} indicates whether the pivot item for stimulus
s is selected into module m, thereby indicating whether the
stimulus is selected in that module.

\item \eqn{m \in r} denote modules belonging to pathway r.

\item The stacked operator, \eqn{\substack{\leq \\ \geq \\ =}} denotes that the specification may take the form of an upper bound, lower bound, or exact value.

\item \eqn{n_c^{stim,m}} specify the required number of stimuli from category level c in module m.

\item \eqn{n_c^{stim,r}} specify the required number of stimuli from category level c in pathway r.
}
}

\examples{
data("reading_itempool")

pivot_stim_map <- create_pivot_stimulus_map(
  itempool   = reading_itempool,
  stimulus   = "stimulus",
  pivot_item = "pivot_item"
)

# Example 1:
# MST 1-3-3 design, 7 modules, 2 stimulus categories (history, social studies).
# Stage 1: ≤ 1 history passage.
# Stage 2 & 3: ≤ 1 history and ≤ 1 social studies passage in each module.

test_mstATA <- mst_design(
  itempool = reading_itempool,
  design   = "1-3-3",
  module_length = c(14,12,12,12,12,12,12),
  pivot_stim_map = pivot_stim_map
)

test_stimcat_con(
  x = test_mstATA,
  attribute = "stimulus_type",
  cat_levels = c("history","social studies"),
  operator = "<=",
  target_num = matrix(
    c(1,0,
      rep(c(1,1), 3),
      rep(c(1,1), 3)),
    nrow = 7, ncol = 2, byrow = TRUE
  )
)


# Example 2:
# Pathway REE requires between 1 and 3 history passages.
con1<-test_stimcat_con(
    x = test_mstATA,
    attribute = "stimulus_type",
    cat_levels = "history",
    operator = ">=",
    target_num = 1,
    which_pathway = 1
  )
con2<-test_stimcat_con(
    x = test_mstATA,
    attribute = "stimulus_type",
    cat_levels = "history",
    operator = "<=",
    target_num = 3,
    which_pathway = 1
  )

}
